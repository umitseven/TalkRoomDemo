@using Newtonsoft.Json
@model TalkRoomDemo.DtoLayer.ViewModel.ServerDetailsViewModel

@{
    Layout = "_HomeLayout";
}
<div class="app-container-discord">

    <!-- Sol Panel -->
    <aside class="sidebar-discord">
        <!-- Oda Adı -->
        <div class="room-name">@Model.Server.ServerName</div>
        <br style="border: 0.5px solid #2f3136;" />

        <!-- Kanallar -->
        <div class="room-in">
            <div class="channel-list">
                <div class="channel"># Genel Sohbet</div>
                <div class="channel"># Sesli Sohbet</div>


                <aside class="ServerUsers-bar">
                    <div class="chanel-header" style="font-size:18px;display:flex; font-weight:600;padding: 10px; margin-top: 1rem; font-size: large;flex-wrap: nowrap;
    align-items: center;
    justify-content: flex-start; ">
                        Odadaki Kişiler
                        <button id="openInviteModal" class="add-room-btn">＋</button>
                    </div>
                    <div style="border: 0.5px solid #2f3136;" class="element"></div>


                    <!-- Odadaki Kişilerin listesi -->

                    <div id="RoomFriends">
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.8/signalr.min.js"></script>

                        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                        <script>
                            $(document).ready(function () {
                                $("#RoomFriends").load("/AddRoom/GetServerUsers?serverId=@Model.Server.ServerID");
                            });
                        </script>
                    </div>

                </aside>


            </div>
            <div id="roomModal" class="modal">
                <div class="modal-content">
                    <div class="cls-h">
                        <span id="closeModalBtn" class="close">&times;</span>
                        <h2>Yeni Oda Oluştur</h2>
                    </div>
                    <div id="roomList">
                        @await Html.PartialAsync("~/Views/AddRoom/AddRoomPartial.cshtml", new TalkRoomDemo.DtoLayer.Dtos.ServerListDto())
                    </div>
                </div>
            </div>
            <div id="copyNotification2" style="
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #4BB543;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s, bottom 0.5s;
    font-weight: 600;
    z-index: 1000;
">
                Yeni oda Oluşturuldu!
            </div>
            <div id="roomModal2" class="modal">
                <div class="modal-content">
                    <div class="cls-h">
                        <span id="closeModalBtn2" class="close">&times;</span>
                        <h2>Davet Kodunuz</h2>
                    </div>

                    <!-- Davet Linki girme ve davet kodu oluşturma -->
                    @await Html.PartialAsync("~/Views/FriendRequest/AcceptInvite.cshtml")

                </div>
            </div>
            <div id="copyNotification" style="
    position: fixed;
    top: 20px;
    right: 0%;
    transform: translateX(-50%);
    background-color: #4BB543;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s, bottom 0.5s;  
    font-weight: 600;
    z-index: 1000;
">
                Kopyalandı!
            </div>

            <!-- Sol alt kullanıcı paneli -->
            <div class="user-panel-bottom">
                <br style="border: 0.5px solid #2f3136;" />
                <img src="@User.FindFirst("ImageUrl")?.Value" alt="Profil" class="profile-pic">
                <span class="username">@User.FindFirst("UserName")?.Value</span>
                <a href="@Url.Action("Settings", "Home")" class="icon-btn settings-btn">⚙️</a>
                <button class="icon-btn mic-btn" onclick="toggleVolumePopup()">🎤</button>
                <div id="volume-popup" class="volume-popup">
                    <label class="volume-label">
                        <input type="checkbox" id="muteCheckbox" />
                        <span>Mute</span>
                    </label>
                    <input type="range" min="0" max="1" step="0.01" value="1" id="volumeSlider" />
                </div>
            </div>
        </div>

    </aside>

    <!--kullanıcı davet modalı -->

    <div id="inviteModal" class="friend-modal">
        <div class="friend-modal-content" style="width:400px;">
            <div class="cls-h" style="display: flex;
justify-content: center;
    align-items: center;
    flex-direction: row;">
                <h2>Kullanıcı Davet Et</h2>
                <span id="closeInviteModal" class="close">&times;</span>
            </div>

            <p>Odaya davet etmek istediğiniz kullanıcının adını girin:</p>
            <input type="text" id="inviteInput" placeholder="Kullanıcı adı örn:umtsvn" style="width:100%;padding:8px;margin:10px 0;border-radius:5px;border:1px solid #555;background:#2f3136;color:white;">
            <button id="sendInviteBtn" style="width:100%;padding:10px;background:#5865f2;color:white;border:none;border-radius:5px;font-weight:600;cursor:pointer;">
                Davet Gönder
            </button>
        </div>
    </div>


    <!-- Chat Alanı -->
    <a href="@Url.Action("Settings", "AddRoom", new { id = Model.Server.ServerID })" class="icon-btn settings-btn" style="    position: fixed;
    top: 7px;
    right: 17%;
    width: 30px;
    height: auto;
    font-size: 24px;padding:8px 8px !important;">⚙️</a>
    <main class="chat-area-discord">
      
        <ul id="messagesList" class="messages-list-discord">
            <!-- Mesajlar JS ile eklenecek -->
           
        </ul>

        <!-- Mesaj Gönderme Alanı -->
        <footer class="message-input-container-discord">

            <input type="hidden" id="currentRoomId" name="currentRoomId" value="@Model.Server.ServerID" />
                <input type="text" id="messageInput" name="content" placeholder="Mesaj yaz…" autocomplete="off" />
            <button type="button" id="sendButton">➤</button>
           
        </footer>
    </main>
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script>
            window.currentUser = window.currentUser = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(User.FindFirst("UserName")?.Value));
        window.currentUserProfileUrl = window.currentUserProfileUrl = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(User.FindFirst("ImageUrl")?.Value));
        
        window.roomId = window.roomId = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Server.ServerID));
    </script>
    <script src="~/js/chat.js"></script>
    <script>
             const messages = @Html.Raw(JsonConvert.SerializeObject(Model.Messages));

        const messagesList = document.getElementById("messagesList");
        messages.forEach(msg => {
            const mine = msg.SenderName === '@User.FindFirst("UserName")?.Value' ? 'mine' : 'other';
            const li = document.createElement('li');
            li.className = mine;
            li.innerHTML = `
                   <div class="message-content">
                <div class="message-username">${msg.SenderName}</div>
                <div class="message-text">${msg.Content}</div>
            </div>
            <img class="message-profile-pic" src="${msg.SenderAvatarUrl}" />
        `;

        messagesList.appendChild(li);
        });

    </script>
    <script>
        // Modal açma/kapama
        const inviteModal = document.getElementById("inviteModal");
        const openInviteModalBtn = document.getElementById("openInviteModal");
        const closeInviteModalBtn = document.getElementById("closeInviteModal");

        openInviteModalBtn.onclick = function () {
            inviteModal.style.display = "block";
        }

        closeInviteModalBtn.onclick = function () {
            inviteModal.style.display = "none";
        }

        window.onclick = function (event) {
            if (event.target == inviteModal) {
                inviteModal.style.display = "none";
            }
        }

        // Davet gönderme butonu
        document.getElementById("sendInviteBtn").addEventListener("click", function () {
            const username = document.getElementById("inviteInput").value.trim();
            const serverId = @Model.Server.ServerID; // isim küçük harfli

            if (!username) return; // boş gönderme engellendi

            const form = document.createElement("form");
            form.method = "POST";
            form.action = '@Url.Action("GetServerUser", "AddRoom")';

            const inputUser = document.createElement("input");
            inputUser.type = "hidden";
            inputUser.name = "UserName";
            inputUser.value = username;
            form.appendChild(inputUser);

            const inputServer = document.createElement("input");
            inputServer.type = "hidden";
            inputServer.name = "serverId";
            inputServer.value = serverId; // doğru değişken
            form.appendChild(inputServer);

            document.body.appendChild(form);
            form.submit();
        });
    </script>


</div>


<style>
    .room-in{
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        flex-wrap: nowrap;
    }
    /* Genel Container */
    .app-container-discord {
        display: flex;
        
        background: #0b0d13;
        color: #fff;
        font-family: "Segoe UI", sans-serif;
    }

    /* Sol Panel */
    .sidebar-discord {
        width: 20%;
        background: #0b0d13;
        height:100vh;
        flex-direction: column;
        justify-content: space-between;
        padding: 12px;
        border-right: 1px solid #2f3136;
    }

    .room-name {
        font-size: 1.6rem;
        font-weight: bold;
        margin-bottom: 12px;
    }

    .channel-list {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .channel {
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }

        .channel:hover {
            background: rgba(255,255,255,0.1);
        }

    /* Kullanıcı paneli */
    .user-panel-bottom {
        
        background: #0b0d13;
        padding: 8px 12px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 100;
        position: fixed;
        bottom: 0px;
        border: 0.7px solid #2f3136;
        width:15%;
    }


    .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }

    .username {
        font-weight: bold;
        color: #fff;
    }

    .icon-btn {
        background: #171b28;
        border: none;
        border-radius: 6px;
        padding: 4px 6px;
        cursor: pointer;
        color: #fff;
        text-decoration: none;
    }

    .status.online {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #22c55e;
    }

    .status.offline {
        background: #6b7280;
    }

    /* Chat Alanı */
    .chat-area-discord {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 80vh;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .messages-list-discord {
        flex: 1;
        padding: 12px;
        height:400px;
        overflow-y: auto;
        overflow-x:hidden;
        display: flex;
        flex-direction: column;
        gap: 8px;
        list-style: none;
        margin: 0;
        background: #0b0d13;
    }

    .message-input-container-discord {
        display: flex;
        padding: 20px;
        border-top: 1px solid #2f3136;
        position: fixed;
        bottom: 0;
        width: 64%;
        background: #0b0d13;
    }

        .message-input-container-discord input {
            flex: 1;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #2f3136;
            background: #0b0d13;
            color: #fff;
        }

        .message-input-container-discord button {
            margin-left: 6px;
            padding: 6px 12px;
            background: #6d7cff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
        }

    .messages-list-discord li {
        display: flex;
        align-items: flex-start;
        margin: 6px 0;
    }

        /* Senin mesajların (sağda) */
        .messages-list-discord li.mine {
            justify-content: flex-end; /* sağa yasla */
            
        }

            .messages-list-discord li.mine .message-content {
               
                color: white;
                text-align: right;
                border-radius: 8px;
                padding: 8px 12px;
                max-width: 60%;
                margin-right:8px;
            }

        /* Diğer kullanıcıların mesajları (solda) */
        .messages-list-discord li.other {
            justify-content: flex-start; /* sola yasla */
            flex-direction:row;
        }

            .messages-list-discord li.other .message-content {
                background-color: #40444B; /* Discord koyu gri */
                color: white;
                text-align: left;
                border-radius: 8px;
                padding: 8px 12px;
                max-width: 60%;
                margin-left:8px;
            }
            .messages-list-discord::-webkit-scrollbar {
    width: 6px;
}

.messages-list-discord::-webkit-scrollbar-thumb {
    background-color: #2f3136;  /* koyu gri */
    border-radius: 3px;
}

.messages-list-discord::-webkit-scrollbar-thumb:hover {
    background-color: #40444b;
}


@*bu kısım odaya arkadaş davet modalının css'leri*@
    .friend-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7);
    }

    .friend-modal-content {
        background-color: #36393f;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 30%;
        border-radius: 10px;
        color: white;
    }

    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

        .close:hover {
            color: white;
        }
</style>


